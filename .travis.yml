sudo: true

language: python

os:
  # - windows # Python not supported yet for travis windows builds 12/11/2018
  - linux
  # - osx # Python not supported yet for travis osx builds 12/11/2018

# ubuntu xenial is required for xvfb (virtual graphics)
dist: xenial

python:
  - 3.5
  - 3.6
  - 3.7

services:
  - xvfb

addons:
  apt:
    packages:
      # for sphinx automodapi
      - graphviz

before_install:
  # prevent travis from timing out for slow processes
  - chmod +x docs/prevent_travis_timeout.sh
  - docs/prevent_travis_timeout.sh &
  - export PREVENT_TRAVIS_TIMEOUT_PID=$!

install:
  # imagepypelines Requirements
  - pip install -r requirements.txt
  - pip install .

  # Sphinx requirements
  - pip install Sphinx==1.8.2 sphinx_bootstrap_theme==0.6.5 m2r sphinx-automodapi
  # codecov and auto-testing requirements
  - pip install pytest sybil pytest-cov hypothesis coverage codecov pytest-doctest-ellipsis-markers --upgrade
  # opencv
  - pip install opencv-python

script:
  # license enforcer
  - python enforcer.py
  # generate percent test coverage and a coverage report - this now includes website examples
  #
  # COMMENTED OUT TEMPORARILTY ON 03/23/2020 SO I CAN WORK ON THE WEBSITE
  # -Jeff
  # UNCOMMENT THE LINE BELOW TO WORK ON THE NEW TESTING SETUP
  # - py.test --cov=./imagepypelines --ignore=setup.py

after_script:
  - kill -9 $PREVENT_TRAVIS_TIMEOUT_PID

after_success:
  # upload coverage report
  - codecov
  # Building website
  - cd docs && make html && cd ..
  - cp CNAME docs/build/html/CNAME

deploy:
  # Website Deployment
  - provider: pages:git
    github-token: $GITHUB_TOKEN
    keep-history: false
    local-dir: docs/build/html
    verbose: true
    # opt into travis's v2 deploy tooling
    edge: true
    on:
      python: '3.6'
      branch: develop

  - provider: pypi
    user: jmaggio14
    password: $PYPI_PASS
    on:
      branch: master
      tags: true
